<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.pj2.shoecream.mapper.AuctionMapper">
	<insert id="insertAuctionItem">
		insert into
			auction_item
		values(
			#{auction_idx}
			, #{mem_idx}
			, #{auction_title}
			, #{auction_info}
			, 'pay'
			, #{lc_code}
			, #{mc_code}
			, now()
			, '0'
			, #{auction_brand}
			, #{auction_size}
			, '1'
			, #{auc_start_price}
			, #{auc_buy_instantly}
			, #{auc_bid_unit}
			, #{auc_regist_date}
			, #{auc_close_date}
			, '대기'
		)
	</insert>
	<select id="selectAuctionList" resultType="map">
		select
		    *
		from
			auction_item ai join product_image pi
			on ai.auction_idx = pi.product_idx
		where
			auc_state = '진행'
		<if test="!orderMethod.equals('')">
		    <choose>
		        <when test="orderMethod.equals('recommended')">
		            <!-- 추천순 정렬 -->
		        </when>
		        <when test="orderMethod.equals('dateorder')">
                    <!-- 최신순 정렬 -->		            
		        </when>
		        <when test="orderMethod.equals('lowPrice')">
                    <!-- 낮은가격순 정렬 -->		            
		        </when>
		        <when test="orderMethod.equals('highPrice')">
                    <!-- 높은가격순 정렬 -->		            
		        </when>
		    </choose>
		</if>
        <if test="startRow != null and listLimit != null">
	        limit
	            #{startRow}
	            , #{listLimit}
        </if>
	</select>
	<select id="selectAuction">
	   select
	       *
	   from
	       auction_item ai join product_image pi 
	       on ai.auction_idx = pi.product_idx join large_category lc
	       on ai.lc_code = lc.lc_code join middle_category mc
	       on ai.mc_code = mc.mc_code
	   where
	       auction_idx = #{auctionx_idx}
	</select>
	
		<select id="selectBidPrice" resultType="String">
		SELECT 
		  COALESCE(MAX(bid_list.bid_price), auction_item.auc_start_price) AS result_price
		FROM 
		  auction_item
		LEFT JOIN 
		  bid_list ON auction_item.auction_idx = bid_list.auction_idx
		WHERE 
		  auction_item.auction_idx = #{auctionx_idx}
	</select>
	
	<insert id="insertBidList">
		insert into
			bid_list
		values(
			#{auction_idx}
			, #{sId}
			, #{bid_price}
			, now()
			, #{deposit}
			, '입찰'
		)
	</insert>
	
</mapper>
